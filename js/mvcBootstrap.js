/**
 * CasaLink MVC Application Bootstrap
 * Loads all MVC components in proper order:
 * 1. Config & Firebase
 * 2. Models (Data layer)
 * 3. Services (Business logic layer)
 * 4. Utilities (Helper functions)
 * 5. Controllers (Orchestration layer)
 * 6. Initialize App
 */

(function() {
    const CACHE_BUSTER = 'v=1.0.4-mvc-' + new Date().getTime();
    
    // MVC Script Loading Order
    const mvcScripts = [
        // Configuration is provided by the main page loader (index.html)
        // 'config/firebase.js' intentionally not loaded here to avoid duplicate declarations
        
        // Models Layer (Data structures)
        'models/User.js',
        'models/Property.js',
        'models/Unit.js',
        'models/Lease.js',
        'models/Bill.js',
        'models/MaintenanceRequest.js',
        
        // Services Layer (Business logic & Firebase operations)
        'services/FirebaseService.js',
        'services/AuthService.js',
        'services/DataService.js',
        
        // Utilities Layer (Helper functions)
        'utilities/constants.js',
        'utilities/helpers.js',
        'utilities/formatters.js',
        
        // Controllers Layer (Orchestration)
        'controllers/AuthController.js',
        'controllers/DashboardController.js',
        'controllers/PropertiesController.js',
        'controllers/TenantsController.js',
        'controllers/BillingController.js',
        'controllers/MaintenanceController.js'
    ];

    // Note: legacy scripts are loaded by the main page loader to avoid duplicate declarations.
    const legacyScripts = [];

    let scriptsLoaded = 0;
    let totalScripts = mvcScripts.length;

    /**
     * Load scripts sequentially
     */
    function loadScripts(scriptList, onComplete) {
        if (scriptList.length === 0) {
            onComplete();
            return;
        }

        const scriptUrl = scriptList.shift() + '?' + CACHE_BUSTER;
        console.log(`üì¶ [${scriptsLoaded + 1}/${totalScripts}] Loading: ${scriptUrl}`);

        const script = document.createElement('script');
        script.src = scriptUrl;
        script.type = 'text/javascript';

        script.onload = function() {
            scriptsLoaded++;
            console.log(`‚úÖ [${scriptsLoaded}/${totalScripts}] Loaded: ${scriptUrl}`);
            loadScripts(scriptList, onComplete);
        };

        script.onerror = function() {
            console.error(`‚ùå Failed to load: ${scriptUrl}`);
            scriptsLoaded++;
            loadScripts(scriptList, onComplete);
        };

        document.head.appendChild(script);
    }

    /**
     * Initialize MVC Application
     */
    function initializeMVCApp() {
        console.log('üöÄ Initializing CasaLink MVC Application...');

        try {
            // Verify Firebase is loaded
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK not loaded');
            }
            console.log('‚úÖ Firebase SDK loaded');

            // Verify all MVC layers are loaded
            const layers = {
                Models: [typeof User !== 'undefined' ? User : null,
                         typeof Property !== 'undefined' ? Property : null,
                         typeof Unit !== 'undefined' ? Unit : null,
                         typeof Lease !== 'undefined' ? Lease : null,
                         typeof Bill !== 'undefined' ? Bill : null,
                         typeof MaintenanceRequest !== 'undefined' ? MaintenanceRequest : null],
                Services: [typeof FirebaseService !== 'undefined' ? FirebaseService : null,
                           typeof AuthService !== 'undefined' ? AuthService : null,
                           typeof DataService !== 'undefined' ? DataService : null],
                Utilities: [typeof AppHelpers !== 'undefined' ? AppHelpers : null,
                            typeof Formatters !== 'undefined' ? Formatters : null,
                            typeof AppConstants !== 'undefined' ? AppConstants : null]
            };

            for (const [layer, checks] of Object.entries(layers)) {
                for (const check of checks) {
                    if (!check) {
                        throw new Error(`${layer} layer not properly loaded`);
                    }
                }
                console.log(`‚úÖ ${layer} layer loaded`);
            }

            // Initialize Firebase services
            console.log('üì° Initializing Firebase services...');
            window.firebaseService = new FirebaseService();
            window.authService = new AuthService(window.firebaseService);
            window.dataService = new DataService(window.firebaseService);
            console.log('‚úÖ Firebase services initialized');

            // Instantiate controllers explicitly now that services exist
            try {
                if (typeof AuthController !== 'undefined' && !window.authController) {
                    window.authController = new AuthController(window.authService, window.dataService);
                    console.log('‚úÖ AuthController instantiated');
                }
                if (typeof DashboardController !== 'undefined' && !window.dashboardController) {
                    window.dashboardController = new DashboardController(window.dataService);
                    console.log('‚úÖ DashboardController instantiated');
                }
                if (typeof PropertiesController !== 'undefined' && !window.propertiesController) {
                    window.propertiesController = new PropertiesController(window.dataService);
                    console.log('‚úÖ PropertiesController instantiated');
                }
                if (typeof TenantsController !== 'undefined' && !window.tenantsController) {
                    window.tenantsController = new TenantsController(window.dataService);
                    console.log('‚úÖ TenantsController instantiated');
                }
                if (typeof BillingController !== 'undefined' && !window.billingController) {
                    window.billingController = new BillingController(window.dataService);
                    console.log('‚úÖ BillingController instantiated');
                }
                if (typeof MaintenanceController !== 'undefined' && !window.maintenanceController) {
                    window.maintenanceController = new MaintenanceController(window.dataService);
                    console.log('‚úÖ MaintenanceController instantiated');
                }
            } catch (instErr) {
                console.warn('‚ö†Ô∏è Controller instantiation warning:', instErr);
            }

            // Provide global utility aliases and view helper shims
            try {
                // Utilities
                if (typeof AppHelpers !== 'undefined') {
                    window.generateId = AppHelpers.generateId.bind(AppHelpers);
                    window.debounce = AppHelpers.debounce.bind(AppHelpers);
                    window.showNotification = function(message, type = 'info') {
                        if (window.notificationManager && typeof window.notificationManager.success === 'function') {
                            if (type === 'success') window.notificationManager.success(message);
                            else if (type === 'error' && typeof window.notificationManager.error === 'function') window.notificationManager.error(message);
                            else window.notificationManager.info ? window.notificationManager.info(message) : console.log(message);
                        } else if (typeof AppHelpers.showToast === 'function') {
                            AppHelpers.showToast(message, type);
                        } else {
                            console.log(`[notification:${type}]`, message);
                        }
                    };
                }

                if (typeof Formatters !== 'undefined') {
                    window.formatCurrency = Formatters.formatCurrency.bind(Formatters);
                    window.formatDate = Formatters.formatDate.bind(Formatters);
                }

                // View helper shims (lightweight - log and delegate if possible)
                window.updateDashboardStats = window.updateDashboardStats || function(stats) {
                    console.log('View helper updateDashboardStats called', stats);
                    if (window.dashboardController && typeof window.dashboardController.updateUI === 'function') {
                        window.dashboardController.updateUI(stats);
                    }
                };

                window.updateDashboardHeader = window.updateDashboardHeader || function(name) {
                    console.log('View helper updateDashboardHeader called with name:', name);
                    const headerEl = document.getElementById('dashboardHeaderName') || document.getElementById('userDisplay');
                    if (headerEl) headerEl.textContent = name;
                };

                // Dashboard loading state helper
                window.setDashboardLoading = window.setDashboardLoading || function(section, isLoading) {
                    try {
                        console.log(`View helper setDashboardLoading called for ${section}:`, isLoading);
                        // Common ID patterns used in UI
                        const idsToTry = [
                            `dashboardLoading_${section}`,
                            `${section}Loading`,
                            `${section}-loading`,
                            `${section}SectionLoading`
                        ];
                        let el = null;
                        for (const id of idsToTry) {
                            el = document.getElementById(id);
                            if (el) break;
                        }
                        if (!el) {
                            // try a selector for a loading spinner inside the section
                            const sectionEl = document.getElementById(section) || document.querySelector(`.${section}-section`);
                            if (sectionEl) el = sectionEl.querySelector('.loading-spinner');
                        }
                        if (el) el.style.display = isLoading ? 'block' : 'none';
                    } catch (e) {
                        console.warn('setDashboardLoading shim error:', e);
                    }
                };

                // Properties loading helper
                window.setPropertiesLoading = window.setPropertiesLoading || function(isLoading) {
                    try {
                        console.log(`View helper setPropertiesLoading called:`, isLoading);
                        const loadingEl = document.getElementById('propertiesLoading') || 
                                         document.getElementById('properties-section-loading');
                        if (loadingEl) {
                            loadingEl.style.display = isLoading ? 'block' : 'none';
                        }
                    } catch (e) {
                        console.warn('setPropertiesLoading shim error:', e);
                    }
                };

                // Tenants loading helper
                window.setTenantsLoading = window.setTenantsLoading || function(isLoading) {
                    try {
                        console.log(`View helper setTenantsLoading called:`, isLoading);
                        const loadingEl = document.getElementById('tenantsLoading') || 
                                         document.getElementById('tenants-section-loading') ||
                                         document.querySelector('#tenantsSection .loading-spinner');
                        if (loadingEl) {
                            loadingEl.style.display = isLoading ? 'block' : 'none';
                        }
                    } catch (e) {
                        console.warn('setTenantsLoading shim error:', e);
                    }
                };

                // Billing loading helper
                window.setBillingLoading = window.setBillingLoading || function(isLoading) {
                    try {
                        console.log(`View helper setBillingLoading called:`, isLoading);
                        const loadingEl = document.getElementById('billingLoading') || 
                                         document.getElementById('bills-section-loading') ||
                                         document.querySelector('#billingSection .loading-spinner');
                        if (loadingEl) {
                            loadingEl.style.display = isLoading ? 'block' : 'none';
                        }
                    } catch (e) {
                        console.warn('setBillingLoading shim error:', e);
                    }
                };

                // Maintenance loading helper
                window.setMaintenanceLoading = window.setMaintenanceLoading || function(isLoading) {
                    try {
                        console.log(`View helper setMaintenanceLoading called:`, isLoading);
                        const loadingEl = document.getElementById('maintenanceLoading') || 
                                         document.getElementById('maintenance-section-loading') ||
                                         document.querySelector('#maintenanceSection .loading-spinner');
                        if (loadingEl) {
                            loadingEl.style.display = isLoading ? 'block' : 'none';
                        }
                    } catch (e) {
                        console.warn('setMaintenanceLoading shim error:', e);
                    }
                };

                // Properties display helper (already exists but ensure it's robust)
                window.displayProperties = window.displayProperties || function(properties) {
                    console.log('View helper displayProperties called with', properties?.length || 0, 'properties');
                    // This would normally update the properties list in the UI
                };

                // Tenants display helper
                window.displayTenants = window.displayTenants || function(tenants) {
                    console.log('View helper displayTenants called with', tenants?.length || 0, 'tenants');
                    // This would normally update the tenants list in the UI
                };

                // Bills display helper
                window.displayBills = window.displayBills || function(bills) {
                    console.log('View helper displayBills called with', bills?.length || 0, 'bills');
                    // This would normally update the bills list in the UI
                };

                // Maintenance requests display helper
                window.displayMaintenanceRequests = window.displayMaintenanceRequests || function(requests) {
                    console.log('View helper displayMaintenanceRequests called with', requests?.length || 0, 'requests');
                    // This would normally update the maintenance requests list in the UI
                };

                // Leases display helper
                window.displayLeases = window.displayLeases || function(leases) {
                    console.log('View helper displayLeases called with', leases?.length || 0, 'leases');
                    // This would normally update the leases list in the UI
                };

                // Backwards-compatible names used by some controllers
                window.displayPropertiesList = window.displayPropertiesList || function(list) {
                    if (typeof window.displayProperties === 'function') return window.displayProperties(list);
                    console.log('View helper displayPropertiesList called', list && list.length);
                };

                window.displayTenantsList = window.displayTenantsList || function(list) {
                    if (typeof window.displayTenants === 'function') return window.displayTenants(list);
                    console.log('View helper displayTenantsList called', list && list.length);
                };

                window.displayBillsList = window.displayBillsList || function(list) {
                    if (typeof window.displayBills === 'function') return window.displayBills(list);
                    console.log('View helper displayBillsList called', list && list.length);
                };

                window.displayMaintenanceList = window.displayMaintenanceList || function(list) {
                    if (typeof window.displayMaintenanceRequests === 'function') return window.displayMaintenanceRequests(list);
                    console.log('View helper displayMaintenanceList called', list && list.length);
                };

                window.displayLeasesList = window.displayLeasesList || function(list) {
                    if (typeof window.displayLeases === 'function') return window.displayLeases(list);
                    console.log('View helper displayLeasesList called', list && list.length);
                };

                // Error handling helpers for Properties
                window.showPropertiesError = window.showPropertiesError || function(message) {
                    console.log('View helper showPropertiesError:', message);
                    const errorEl = document.getElementById('propertiesError') || 
                                   document.querySelector('#propertiesSection .error-message') ||
                                   document.querySelector('#propertiesSection [class*="error"]');
                    if (errorEl) {
                        errorEl.textContent = message;
                        errorEl.style.display = 'block';
                    }
                };

                window.hidePropertiesError = window.hidePropertiesError || function() {
                    console.log('View helper hidePropertiesError');
                    const errorEl = document.getElementById('propertiesError') || 
                                   document.querySelector('#propertiesSection .error-message') ||
                                   document.querySelector('#propertiesSection [class*="error"]');
                    if (errorEl) {
                        errorEl.style.display = 'none';
                    }
                };

                // Error handling helpers for Tenants
                window.showTenantsError = window.showTenantsError || function(message) {
                    console.log('View helper showTenantsError:', message);
                    const errorEl = document.getElementById('tenantsError') || 
                                   document.querySelector('#tenantsSection .error-message') ||
                                   document.querySelector('#tenantsSection [class*="error"]');
                    if (errorEl) {
                        errorEl.textContent = message;
                        errorEl.style.display = 'block';
                    }
                };

                window.hideTenantsError = window.hideTenantsError || function() {
                    console.log('View helper hideTenantsError');
                    const errorEl = document.getElementById('tenantsError') || 
                                   document.querySelector('#tenantsSection .error-message') ||
                                   document.querySelector('#tenantsSection [class*="error"]');
                    if (errorEl) {
                        errorEl.style.display = 'none';
                    }
                };

                // Error handling helpers for Billing
                window.showBillingError = window.showBillingError || function(message) {
                    console.log('View helper showBillingError:', message);
                    const errorEl = document.getElementById('billingError') || 
                                   document.querySelector('#billingSection .error-message') ||
                                   document.querySelector('#billingSection [class*="error"]');
                    if (errorEl) {
                        errorEl.textContent = message;
                        errorEl.style.display = 'block';
                    }
                };

                window.hideBillingError = window.hideBillingError || function() {
                    console.log('View helper hideBillingError');
                    const errorEl = document.getElementById('billingError') || 
                                   document.querySelector('#billingSection .error-message') ||
                                   document.querySelector('#billingSection [class*="error"]');
                    if (errorEl) {
                        errorEl.style.display = 'none';
                    }
                };

                // Error handling helpers for Maintenance
                window.showMaintenanceError = window.showMaintenanceError || function(message) {
                    console.log('View helper showMaintenanceError:', message);
                    const errorEl = document.getElementById('maintenanceError') || 
                                   document.querySelector('#maintenanceSection .error-message') ||
                                   document.querySelector('#maintenanceSection [class*="error"]');
                    if (errorEl) {
                        errorEl.textContent = message;
                        errorEl.style.display = 'block';
                    }
                };

                window.hideMaintenanceError = window.hideMaintenanceError || function() {
                    console.log('View helper hideMaintenanceError');
                    const errorEl = document.getElementById('maintenanceError') || 
                                   document.querySelector('#maintenanceSection .error-message') ||
                                   document.querySelector('#maintenanceSection [class*="error"]');
                    if (errorEl) {
                        errorEl.style.display = 'none';
                    }
                };

                // Stats update helpers
                window.updateBillingStats = window.updateBillingStats || function(stats) {
                    console.log('View helper updateBillingStats:', stats);
                    try {
                        // Update total bills
                        const totalEl = document.querySelector('[data-stat="total-bills"]');
                        if (totalEl) totalEl.textContent = stats.total || 0;
                        
                        // Update overdue
                        const overdueEl = document.querySelector('[data-stat="overdue-bills"]');
                        if (overdueEl) overdueEl.textContent = stats.overdueAmount || 0;
                        
                        // Update collected
                        const collectedEl = document.querySelector('[data-stat="collected-amount"]');
                        if (collectedEl) collectedEl.textContent = stats.collectedAmount || 0;
                    } catch (e) {
                        console.warn('Error updating billing stats display:', e);
                    }
                };

                window.updateMaintenanceStats = window.updateMaintenanceStats || function(stats) {
                    console.log('View helper updateMaintenanceStats:', stats);
                    try {
                        // Update pending
                        const pendingEl = document.querySelector('[data-stat="pending-requests"]');
                        if (pendingEl) pendingEl.textContent = stats.pending || 0;
                        
                        // Update in-progress
                        const inProgressEl = document.querySelector('[data-stat="in-progress-requests"]');
                        if (inProgressEl) inProgressEl.textContent = stats.inProgress || 0;
                        
                        // Update closed
                        const closedEl = document.querySelector('[data-stat="closed-requests"]');
                        if (closedEl) closedEl.textContent = stats.closed || 0;
                    } catch (e) {
                        console.warn('Error updating maintenance stats display:', e);
                    }
                };

                // Pagination helper
                window.updatePagination = window.updatePagination || function(currentPage, totalPages, onPageChange) {
                    console.log('View helper updatePagination:', { currentPage, totalPages });
                    try {
                        const paginationEl = document.querySelector('.pagination') || 
                                            document.querySelector('[data-component="pagination"]');
                        if (paginationEl) {
                            // Clear existing pagination buttons
                            paginationEl.innerHTML = '';
                            
                            // Add previous button
                            if (currentPage > 1) {
                                const prevBtn = document.createElement('button');
                                prevBtn.textContent = '‚Üê Previous';
                                prevBtn.className = 'btn btn-sm btn-outline-secondary';
                                prevBtn.onclick = () => onPageChange(currentPage - 1);
                                paginationEl.appendChild(prevBtn);
                            }
                            
                            // Add page info
                            const pageInfo = document.createElement('span');
                            pageInfo.className = 'pagination-info';
                            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                            paginationEl.appendChild(pageInfo);
                            
                            // Add next button
                            if (currentPage < totalPages) {
                                const nextBtn = document.createElement('button');
                                nextBtn.textContent = 'Next ‚Üí';
                                nextBtn.className = 'btn btn-sm btn-outline-secondary';
                                nextBtn.onclick = () => onPageChange(currentPage + 1);
                                paginationEl.appendChild(nextBtn);
                            }
                        }
                    } catch (e) {
                        console.warn('Error updating pagination display:', e);
                    }
                };

            } catch (shimErr) {
                console.warn('‚ö†Ô∏è Utility/view shim warning:', shimErr);
            }

            // Wait for controllers to auto-initialize
            setTimeout(() => {
                verifyControllers();
                initializeApp();
            }, 500);

        } catch (error) {
            console.error('‚ùå MVC Initialization Error:', error);
            showError('Application Initialization Error', error.message);
        }
    }

    /**
     * Verify all controllers are initialized
     */
    function verifyControllers() {
        const controllers = {
            'Auth': window.authController,
            'Dashboard': window.dashboardController,
            'Properties': window.propertiesController,
            'Tenants': window.tenantsController,
            'Billing': window.billingController,
            'Maintenance': window.maintenanceController
        };

        for (const [name, controller] of Object.entries(controllers)) {
            if (controller) {
                console.log(`‚úÖ ${name}Controller initialized`);
            } else {
                console.warn(`‚ö†Ô∏è ${name}Controller not initialized`);
            }
        }
    }

    /**
     * Initialize Application
     */
    function initializeApp() {
        console.log('üéØ Initializing application with auth waiting...');

        try {
            // Set up global auth state tracking
            window.authReady = false;
            window.currentUser = null;
            
            // Define function to handle authenticated state
            const handleAuthenticated = (user) => {
                if (user) {
                    console.log('‚úÖ User authenticated:', user.email);
                    window.currentUser = user;
                    window.authReady = true;
                    
                    // Initialize controllers that need authentication
                    initializeAuthenticatedControllers();
                    
                    // Hide login, show app
                    const loginSection = document.getElementById('loginSection');
                    const appSection = document.getElementById('appSection');
                    if (loginSection) loginSection.style.display = 'none';
                    if (appSection) appSection.style.display = 'block';
                } else {
                    console.log('‚ÑπÔ∏è No user authenticated, showing login');
                    window.authReady = false;
                    window.currentUser = null;
                    
                    // Initialize auth controller for login form
                    if (window.authController && typeof window.authController.init === 'function') {
                        window.authController.init();
                    }
                    
                    // Show login, hide app
                    const loginSection = document.getElementById('loginSection');
                    const appSection = document.getElementById('appSection');
                    if (loginSection) loginSection.style.display = 'block';
                    if (appSection) appSection.style.display = 'none';
                }
            };

            /**
             * Wait for authentication before initializing controllers
             */
            function waitForAuthAndInitialize() {
                console.log('‚è≥ Waiting for authentication...');
                
                // Set a timeout in case auth never happens
                const authTimeout = setTimeout(() => {
                    console.warn('‚ö†Ô∏è Auth timeout - proceeding with unauthenticated state');
                    handleAuthenticated(null);
                }, 10000); // 10 second timeout
                
                // Use AuthManager when available
                if (window.AuthManager && typeof window.AuthManager.onAuthChange === 'function') {
                    console.log('üîê Using AuthManager for authentication');
                    window.AuthManager.onAuthChange((enhancedUser) => {
                        clearTimeout(authTimeout);
                        handleAuthenticated(enhancedUser);
                    });
                } 
                // Fallback to Firebase auth
                else if (window.firebaseService && typeof window.firebaseService.onAuthStateChanged === 'function') {
                    console.log('üîê Using FirebaseService for authentication');
                    window.firebaseService.onAuthStateChanged((user) => {
                        clearTimeout(authTimeout);
                        handleAuthenticated(user);
                    });
                }
                // Legacy fallback
                else if (typeof firebase !== 'undefined' && firebase.auth) {
                    console.log('üîê Using Firebase auth directly');
                    firebase.auth().onAuthStateChanged((user) => {
                        clearTimeout(authTimeout);
                        handleAuthenticated(user);
                    });
                }
                else {
                    console.error('‚ùå No authentication method available');
                    clearTimeout(authTimeout);
                    handleAuthenticated(null);
                }
            }

            /**
             * Initialize controllers that require authentication
             */
            function initializeAuthenticatedControllers() {
                console.log('üöÄ Initializing authenticated controllers...');
                
                // Wait a bit to ensure window.currentUser is set
                setTimeout(() => {
                    console.log('üë§ Current user for controllers:', window.currentUser ? window.currentUser.email : 'null');
                    
                    // Initialize controllers in order with error handling
                    const controllerInitOrder = [
                        { name: 'dashboardController', method: 'init' },
                        { name: 'propertiesController', method: 'init' },
                        { name: 'tenantsController', method: 'init' },
                        { name: 'billingController', method: 'init' },
                        { name: 'maintenanceController', method: 'init' }
                    ];
                    
                    let delay = 0;
                    controllerInitOrder.forEach(({ name, method }) => {
                        setTimeout(() => {
                            const controller = window[name];
                            if (controller && typeof controller[method] === 'function') {
                                console.log(`‚úÖ Initializing ${name}...`);
                                try {
                                    controller[method]();
                                } catch (error) {
                                    console.error(`‚ùå Error initializing ${name}:`, error);
                                }
                            } else {
                                console.warn(`‚ö†Ô∏è ${name} not available for initialization`);
                            }
                        }, delay);
                        
                        delay += 200; // Stagger initialization
                    });
                    
                    console.log('‚úÖ All authenticated controllers initialized');
                }, 300); // 300ms delay to ensure auth is ready
            }

            // Start waiting for authentication
            waitForAuthAndInitialize();

            // Hide loading spinner with delay
            setTimeout(() => {
                const spinner = document.getElementById('loadingSpinner');
                if (spinner) {
                    spinner.style.display = 'none';
                    console.log('‚úÖ Loading spinner hidden');
                }
            }, 1000);

            console.log('‚úÖ Application initialization started');

        } catch (error) {
            console.error('‚ùå Application initialization failed:', error);
            showError('Initialization Error', error.message);
        }
    }

    /**
     * Show error message
     */
    function showError(title, message) {
        const appElement = document.getElementById('app');
        if (appElement) {
            appElement.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; font-family: Arial, sans-serif;">
                    <div style="text-align: center; max-width: 500px; padding: 40px;">
                        <h1 style="color: #d32f2f; margin-bottom: 20px;">‚ö†Ô∏è ${title}</h1>
                        <p style="color: #666; margin-bottom: 20px; font-size: 16px;">${message}</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            Reload Page
                        </button>
                    </div>
                </div>
            `;
        }
    }

    /**
     * Start loading scripts
     */
    console.log('üîß CasaLink MVC Bootstrap Starting...');
    console.log(`üìã Loading ${mvcScripts.length} MVC scripts + ${legacyScripts.length} legacy scripts`);

    // Load MVC scripts first
    const allScripts = [...mvcScripts, ...legacyScripts];
    loadScripts(allScripts, initializeMVCApp);
})();